---
title: "Models"
author: "Ezinne Nwankwo"
date: "1/26/2020"
output: pdf_document
---

```{r libraries, include=FALSE}

#library(BMA)
#library(BMS)
#install.packages("BAS")
#devtools::install_github("merliseclyde/BAS");
library(BAS)
library("tidyverse")
#install.packages("randomForest")
library(randomForest)
install.packages(c("maps", "mapdata"))
devtools::install_github("dkahle/ggmap")
#install.packages("rlang")
library(ggmap)
library(maps)
library(mapdata)
set.seed(2020)

```


```{r load_data, include=FALSE}
load("~/Homework/STAT 723/Case-Study-2-team-3/d_clean.RDATA")
```

### Simple Linear Model 

```{r lm_models}
##removing variables not used for price model and moving price to front of dataframe
df_pricemod <- d_clean%>% 
  select(-id,-name,-host_id, -host_name, -popularity, -price, -neighbourhood, -latitude, -longitude, -minimum_nights, -days_since_last, -dist_closest_metro) %>% 
  mutate(type_stay = recode_factor(type_stay, 
                                   "Short" = "Short", 
                                   "Long" = "Long")) %>% 
  select(price_log, everything()) %>% 
  drop_na()

df_pricemod1 <- d_clean%>% 
  select(-id,-name,-host_id, -host_name, -popularity, -price, -neighbourhood, -minimum_nights, -days_since_last, -dist_closest_metro) %>% 
  mutate(type_stay = recode_factor(type_stay, 
                                   "Short" = "Short", 
                                   "Long" = "Long")) %>% 
  select(price_log, everything()) %>% 
  drop_na()

df_popmod <- d_clean%>% 
  mutate(popularity_log =  log(popularity)) %>% 
  select(-id,-name,-host_id, -host_name, -price, -neighbourhood, -minimum_nights, -days_since_last, -dist_closest_metro, -price_log, -popularity) %>% 
  mutate(type_stay = recode_factor(type_stay, 
                                   "Short" = "Short", 
                                   "Long" = "Long")) %>% 
  select(popularity_log, everything()) %>% 
  drop_na()


#simple lm model for price
lm_price<-lm(price_log ~ .,data = df_pricemod)
summary(lm_price)

#simple lm model for popularity
lm_pop<-lm(popularity_log ~ .,data = df_popmod)
summary(lm_pop)

```

### BMA models

```{r bma}
############### Price Models #######################
#BMA model with Cauchy prior
price.JZS <- bas.lm(price_log ~ ., data = df_pricemod, prior = "JZS", 
                    alpha = 1, 
                    n.models = 2^15,
                    modelprior = uniform(),
                    initprobs = "marg-eplogp",
                    method = "MCMC")

#print(price.JZS )
#image(price.JZS , rotate = F)
#par(mfrow=c(2,2))
#plot(price.JZS )
coef.priceJZS <- coef(price.JZS)
confint(coef.priceJZS)
plot(confint(coef.priceJZS, estimator = "HPM"))
saveRDS(price.JZS, "~/Homework/STAT 723/Case-Study-2-team-3/Ezinne/saved_Models/price_bma_JZS.rds")

#BMA model with g  prior
price.g <- bas.lm(price_log ~ ., data = df_pricemod, prior = "g-prior", 
                    alpha = 1, 
                    n.models = 2^15,
                    modelprior = uniform(),
                    initprobs = "marg-eplogp",
                    method = "MCMC")

#print(price.g)
image(price.g, rotate = F)
#par(mfrow=c(2,2))
#plot(price.g)
coef.priceg <- coef(price.g)
confint(coef.priceg)
plot(confint(coef.priceg, estimator = "HPM"))
saveRDS(price.g, "~/Homework/STAT 723/Case-Study-2-team-3/Ezinne/saved_Models/price_bma_g.rds")


######## Popularity Models #################
#BMA model with Cauchy prior
pop.JZS <- bas.lm(popularity_log ~ ., data = df_popmod, prior = "JZS", 
                    alpha = 1, 
                    n.models = 2^15,
                    modelprior = uniform(),
                    initprobs = "marg-eplogp",
                    method = "MCMC")

#print(price.JZS )
#image(price.JZS , rotate = F)
#par(mfrow=c(2,2))
#plot(price.JZS )
coef.popJZS <- coef(pop.JZS)
confint(coef.popJZS)
plot(confint(coef.popJZS, estimator = "HPM"))
saveRDS(pop.JZS, "~/Homework/STAT 723/Case-Study-2-team-3/Ezinne/saved_Models/pop_bma_JZS.rds")

#BMA model with g  prior
pop.g <- bas.lm(popularity_log ~ ., data = df_popmod, prior = "g-prior", 
                    alpha = 1, 
                    n.models = 2^15,
                    modelprior = uniform(),
                    initprobs = "marg-eplogp",
                    method = "MCMC")

#print(price.g)
image(pop.g, rotate = F)
#par(mfrow=c(2,2))
#plot(price.g)
coef.popg <- coef(pop.g)
confint(coef.popg)
plot(confint(coef.popg, estimator = "HPM"))
saveRDS(pop.g, "~/Homework/STAT 723/Case-Study-2-team-3/Ezinne/saved_Models/pop_bma_g.rds")

#Lets remove the outliers
pop_sumstats <- df_popmod %>% summarise(avg_pop = mean(log(popularity)), sd_pop = sd(log(popularity)), min_pop = min(log(popularity)), max_pop = max(log(popularity)))

df_popmod_no_outliers <- df_popmod %>% 
  select(-popularity) %>% 
  select(log_popularity,  everything()) %>% 
  filter(near(log_popularity, pop_sumstats$avg_pop, tol = 3*pop_sumstats$sd_pop))

#Rerun model with no outliers
pop_bma2 <- bas.lm(log_popularity ~ ., data = df_popmod_no_outliers, prior = "JZS", 
                    alpha = 1, 
                    n.models = 2^15,
                    initprobs = "marg-eplogp",
                    method = "MCMC")

print(pop_bma2)
image(pop_bma2, rotate = F)
#par(mfrow=c(2,2))
plot(pop_bma2)

```


### Random Forest 

```{r rf, cache=TRUE}

## random forest model for price
rf.price = randomForest(price_log ~ ., ntree = 1500, sampsize = 4000, data = df_pricemod, do.trace = 100)
saveRDS(rf.price, "~/Homework/STAT 723/Case-Study-2-team-3/Ezinne/saved_Models/price_rf.rds")

## random forest model for popularity
rf.pop = randomForest(popularity_log ~ ., ntree = 1500, sampsize = 4000, data = df_popmod, do.trace = 100)
saveRDS(rf.pop, "~/Homework/STAT 723/Case-Study-2-team-3/Ezinne/saved_Models/pop_rf.rds")
```


### Random Forest 

```{r}
## residuals for price model
rf.residuals.price <- df_pricemod$price_log - predict(rf.price) 
plot(rf.residuals.price, ylim = c(-20,30),main = "Residuals from Random Forest Model")
round(importance(rf.price), 2)

## residuals for popularity model

rf.residuals.pop <- df_popmod$popularity_log - predict(rf.pop) 
plot(rf.residuals.pop, ylim = c(-20,30),main = "Residuals from Random Forest Model")
round(importance(rf.pop), 2)

```



### Residual Heat Maps

https://eriqande.github.io/rep-res-web/lectures/making-maps-with-R.html
```{r}

df.residuals.rf <- df_pricemod1 %>% 
  select(price_log, latitude,longitude, neighbourhood_group) %>% 
  mutate(rf_residuals = rf.residuals.price ) %>% 
  mutate 
  as.data.frame() 

states <- map_data("state")
ny_data <- subset(states, region == "new york")
counties <- map_data("county")
ny_county <- subset(counties, region == "new york")
ny_base <- ggplot(data = ny_data, mapping = aes(x = long, y = lat, group = group)) + 
  coord_fixed(1.3) + 
  geom_polygon(color = "black", fill = "gray")
ny_base + theme_nothing()

ny_base + theme_nothing() + 
  geom_polygon(data = ny_county, fill = NA, color = "white") +
  geom_polygon(color = "black", fill = NA)  # get the state border back on top 

elbow_room1 <- ny_base + 
      geom_polygon(data = df.residuals.rf, aes(fill = rf.residuals), color = "white") +
      geom_polygon(color = "black", fill = NA) +
      theme_bw() 

elbow_room1 

```

